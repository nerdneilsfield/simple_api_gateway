# 开发指南

<cite>
**本文档中引用的文件**
- [main.go](file://main.go)
- [cmd/root.go](file://cmd/root.go)
- [cmd/serve.go](file://cmd/serve.go)
- [cmd/check.go](file://cmd/check.go)
- [cmd/gen.go](file://cmd/gen.go)
- [cmd/version.go](file://cmd/version.go)
- [internal/config/config.go](file://internal/config/config.go)
- [internal/router/router.go](file://internal/router/router.go)
- [internal/cache/cache.go](file://internal/cache/cache.go)
- [internal/loadbalancer/loadbalancer.go](file://internal/loadbalancer/loadbalancer.go)
- [Makefile](file://Makefile)
- [justfile](file://justfile)
- [.golang-ci.yml](file://.golang-ci.yml)
- [go.mod](file://go.mod)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [本地开发环境搭建](#本地开发环境搭建)
4. [构建与依赖管理](#构建与依赖管理)
5. [代码风格与静态检查](#代码风格与静态检查)
6. [测试策略](#测试策略)
7. [贡献流程](#贡献流程)
8. [调试技巧](#调试技巧)
9. [扩展开发指导](#扩展开发指导)

## 简介

本开发指南旨在为贡献者提供全面的开发环境搭建和项目改进指导。文档详细说明了如何配置本地开发环境、使用构建工具、遵循代码规范、编写测试以及参与项目贡献。通过本指南，开发者可以快速上手并有效参与到 simple_api_gateway 项目的开发中。

## 项目结构

项目采用标准的 Go 项目结构，主要分为以下几个目录：

- `cmd/`: 包含命令行接口相关代码，实现了 `serve`、`check`、`gen` 和 `version` 四个子命令
- `internal/`: 包含内部包，分为 `config`（配置解析和验证）、`router`（路由设置和请求处理）、`cache`（缓存实现）和 `loadbalancer`（负载均衡实现）
- `scripts/`: 包含系统服务脚本和安装后处理脚本
- `tools/`: 包含开发工具依赖声明

这种结构设计遵循了 Go 项目的最佳实践，将外部可导入的代码与内部实现细节分离，提高了代码的可维护性和安全性。

**Section sources**
- [README.md](file://README.md#L398-L409)

## 本地开发环境搭建

### Go 版本要求

项目要求 Go 1.23.2 或更高版本。您可以通过以下命令检查当前 Go 版本：

```bash
go version
```

如果需要安装或升级 Go，请访问 [Go 官方网站](https://golang.org/dl/) 下载适合您操作系统的版本。

### 依赖安装

项目使用 Go Modules 进行依赖管理。克隆项目后，进入项目目录并运行以下命令来安装所有依赖：

```bash
git clone https://github.com/nerdneilsfield/simple_api_gateway.git
cd simple_api_gateway
go mod tidy
```

### 开发工具安装

项目使用多种开发工具来保证代码质量和一致性。通过以下命令安装所有必要的开发工具：

```bash
make bootstrap
```

或使用 just 命令：

```bash
just bootstrap
```

这些工具包括：
- `gofumpt` 和 `gci`: 代码格式化工具
- `golangci-lint`: 静态代码分析工具
- `gocyclo`: 循环复杂度检查工具
- `staticcheck`: 静态分析工具
- `goimports`: 导入格式化工具

**Section sources**
- [Makefile](file://Makefile#L25-L34)
- [justfile](file://justfile#L36-L45)
- [go.mod](file://go.mod#L1-L203)
- [tools/tools.go](file://tools/tools.go#L1-L24)

## 构建与依赖管理

### Makefile 目标

Makefile 提供了多个构建目标，简化了常见的开发任务：

```makefile
build: ## 构建 Golang 二进制文件
    @go build -ldflags "-X main.version=$(shell git describe --abbrev=0 --tags)" -o $(projectname)

install: ## 安装 Golang 二进制文件
    @go install -ldflags "-X main.version=$(shell git describe --abbrev=0 --tags)"

run: ## 运行应用程序
    @go run -ldflags "-X main.version=$(shell git describe --abbrev=0 --tags)"  main.go

test: clean ## 显示测试覆盖率
    go test --cover -parallel=1 -v -coverprofile=coverage.out ./...
    go tool cover -func=coverage.out | sort -rnk3

lint: ## lint go 文件
    golangci-lint run -c .golang-ci.yml

check: fmt vet cyclo staticcheck imports lint ## 运行所有代码检查
    @echo "All code checks passed!"
```

### justfile 目标

justfile 提供了跨平台的构建命令，支持 Windows、Linux 和 macOS：

```just
build:  # 构建 Golang 二进制文件
    go build -ldflags "-X main.version=$(git describe --abbrev=0 --tags)" -o {{projectname}}

test: clean  # 运行测试并显示覆盖率
    go test --cover -parallel=1 -v -coverprofile=coverage.out ./...
    go tool cover -func=coverage.out | sort -rnk3

check: fmt vet cyclo staticcheck imports lint  # 运行所有代码检查
    @echo "All code checks passed!"
```

### 常用构建命令

- `make build` 或 `just build`: 构建项目二进制文件
- `make run` 或 `just run`: 运行项目
- `make test` 或 `just test`: 运行测试并显示覆盖率
- `make lint` 或 `just lint`: 运行代码检查
- `make check` 或 `just check`: 运行所有代码检查

**Section sources**
- [Makefile](file://Makefile#L1-L85)
- [justfile](file://justfile#L1-L96)

## 代码风格与静态检查

### 代码格式化

项目使用 `gofumpt` 和 `gci` 进行代码格式化。`gofumpt` 是 `gofmt` 的严格版本，强制执行更严格的格式规则；`gci` 用于对导入语句进行分组和排序。

运行以下命令格式化代码：

```bash
make fmt
```

或

```bash
just fmt
```

### 静态检查配置

项目使用 `golangci-lint` 进行静态代码分析，配置文件位于 `.golang-ci.yml`。配置启用了所有检查器，但禁用了部分不适用的检查：

```yaml
linters-settings:
  lll:
    line-length: 180
linters:
  enable-all: true
  disable:
    - testpackage
    - forbidigo
    - paralleltest
    - exhaustivestruct
    - varnamelen
    - interfacer
    - maligned
    - scopelint
    - golint
    - varcheck
    - nosnakecase
    - deadcode
    - ifshort
    - structcheck
    - rowserrcheck
    - sqlclosecheck
    - structcheck
    - wastedassign
    - exhaustruct
    - nolintlint
    - wrapcheck
```

运行以下命令执行静态检查：

```bash
make lint
```

或

```bash
just lint
```

### 循环复杂度检查

项目使用 `gocyclo` 检查函数的循环复杂度，阈值设置为 15。复杂度过高的函数需要重构以提高可读性和可维护性。

```bash
make cyclo
```

或

```bash
just cyclo
```

**Section sources**
- [.golang-ci.yml](file://.golang-ci.yml#L1-L27)
- [Makefile](file://Makefile#L62-L64)
- [justfile](file://justfile#L73-L75)

## 测试策略

### 单元测试

项目使用 Go 内置的测试框架进行单元测试。测试文件通常位于对应包的目录中，文件名以 `_test.go` 结尾。

运行测试的命令：

```bash
make test
```

或

```bash
just test
```

### 测试覆盖率

项目要求高测试覆盖率，使用以下命令查看详细覆盖率报告：

```bash
make cover
```

或

```bash
just cover
```

### 集成测试

项目通过 `cmd` 包中的命令行接口进行集成测试，验证各个组件的协同工作。测试包括：

- 配置文件解析和验证
- 服务器启动和路由处理
- 缓存功能验证
- 负载均衡功能验证

### 测试最佳实践

1. 为每个函数和方法编写测试用例
2. 覆盖正常路径和异常路径
3. 使用表驱动测试（table-driven tests）提高测试效率
4. 为边界条件编写测试
5. 保持测试的独立性和可重复性

**Section sources**
- [Makefile](file://Makefile#L35-L48)
- [justfile](file://justfile#L46-L58)

## 贡献流程

### 分支策略

项目采用简单的分支策略：

1. 从 `main` 分支创建功能分支
2. 在功能分支上进行开发
3. 提交 Pull Request 到 `main` 分支
4. 经过代码审查后合并

```bash
git checkout main
git pull origin main
git checkout -b feature/your-feature-name
# 进行开发
git add .
git commit -m "feat: add your feature"
git push origin feature/your-feature-name
```

### 代码审查

所有 Pull Request 都需要经过代码审查。审查重点包括：

- 代码功能是否正确实现
- 是否遵循项目代码风格
- 是否有足够的测试覆盖
- 是否有潜在的性能问题
- 是否有安全漏洞

### 提交规范

项目遵循语义化提交规范，提交消息格式如下：

```
<type>: <description>

[optional body]

[optional footer]
```

其中 `type` 可以是：
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 贡献步骤

1. Fork 项目仓库
2. 克隆到本地
3. 创建功能分支
4. 实现功能或修复问题
5. 运行所有检查和测试
6. 提交更改
7. 推送到远程分支
8. 创建 Pull Request

**Section sources**
- [README.md](file://README.md#L430-L434)

## 调试技巧

### 日志调试

项目使用 `zap` 日志库，提供了详细的日志记录功能。通过 `--verbose` 或 `-v` 参数启用详细日志输出：

```bash
simple-api-gateway serve config.toml --verbose
```

在代码中添加日志语句：

```go
logger.Debug("Handling request", 
    zap.String("path", requestPath),
    zap.String("method", requestMethod))
```

### 断点调试

使用 Go 调试器（如 delve）进行断点调试：

```bash
dlv debug main.go -- serve config.toml
```

在 IDE 中设置断点，可以逐步执行代码并检查变量状态。

### 请求处理流程调试

请求处理流程主要在 `internal/router/router.go` 中实现。关键调试点包括：

1. `CreateNewHandler`: 创建路由处理程序
2. `handleBackendRequest`: 处理后端请求
3. `sendProxyRequest`: 发送代理请求
4. `tryGetFromCache`: 尝试从缓存获取响应
5. `tryCacheResponse`: 尝试缓存响应

### 性能分析

使用 Go 的性能分析工具进行性能调优：

```bash
# CPU 性能分析
go tool pprof http://localhost:8080/debug/pprof/profile

# 内存性能分析
go tool pprof http://localhost:8080/debug/pprof/heap
```

**Section sources**
- [cmd/root.go](file://cmd/root.go#L11-L50)
- [internal/router/router.go](file://internal/router/router.go#L1-L504)

## 扩展开发指导

### 缓存策略扩展

项目提供了灵活的缓存接口，可以轻松扩展新的缓存策略。`Cache` 接口定义了基本的缓存操作：

```go
type Cache interface {
    Get(key string) (*CacheItem, error)
    Set(key string, value *CacheItem, ttl int) error
    Delete(key string) error
    Close() error
}
```

要实现新的缓存策略，需要：

1. 创建新的缓存结构体
2. 实现 `Cache` 接口的所有方法
3. 在 `NewCacheManager` 中添加对新缓存的支持

例如，实现一个基于文件系统的缓存：

```go
type FileCache struct {
    dir string
}

func (c *FileCache) Get(key string) (*CacheItem, error) {
    // 实现从文件读取
}

func (c *FileCache) Set(key string, value *CacheItem, ttl int) error {
    // 实现写入文件
}

func (c *FileCache) Delete(key string) error {
    // 实现删除文件
}

func (c *FileCache) Close() error {
    // 实现资源清理
}
```

### 负载均衡算法扩展

项目当前实现了轮询负载均衡算法，通过 `LoadBalancer` 接口可以扩展其他算法：

```go
type LoadBalancer interface {
    NextBackend() string
    ReportSuccess(backend string, responseTime time.Duration)
    ReportFailure(backend string)
    GetBackends() []string
    GetHealthyBackends() []string
}
```

要实现新的负载均衡算法，需要：

1. 创建新的负载均衡结构体
2. 实现 `LoadBalancer` 接口
3. 在路由初始化时选择使用新的负载均衡器

例如，实现基于响应时间的加权负载均衡：

```go
type WeightedLoadBalancer struct {
    backends []BackendStatus
    mutex    sync.RWMutex
}

func (lb *WeightedLoadBalancer) NextBackend() string {
    // 基于响应时间权重选择后端
}

func (lb *WeightedLoadBalancer) ReportSuccess(backend string, responseTime time.Duration) {
    // 更新后端响应时间统计
}
```

### 接口设计原则

在扩展功能时，应遵循以下设计原则：

1. **单一职责原则**: 每个结构体和方法应该只有一个职责
2. **开闭原则**: 对扩展开放，对修改关闭
3. **依赖倒置原则**: 依赖抽象而不是具体实现
4. **接口隔离原则**: 客户端不应该依赖它不需要的接口
5. **里氏替换原则**: 子类型必须能够替换它们的基类型

通过遵循这些原则，可以确保扩展的功能与现有代码良好集成，同时保持代码的可维护性和可扩展性。

**Section sources**
- [internal/cache/cache.go](file://internal/cache/cache.go#L21-L26)
- [internal/loadbalancer/loadbalancer.go](file://internal/loadbalancer/loadbalancer.go#L27-L47)